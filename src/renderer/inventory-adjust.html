<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تسوية كمية</title><style>*{box-sizing:border-box;font-family:Tahoma,Arial,sans-serif;}body{margin:0;background:#f0f4f8;color:#0d2d3a;}header{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:2px solid #000;background:#fff;}h1{margin:0;font-size:20px;font-weight:800;}button.btn{cursor:pointer;font-size:13px;font-weight:700;padding:9px 18px;border:2px solid #000;background:linear-gradient(135deg,#ffffff,#f3f9ff);border-radius:14px;transition:.25s;}button.btn:hover{background:#eaf4ff;transform:translateY(-2px);}main{padding:18px;display:grid;gap:18px;grid-template-columns:300px 1fr;}fieldset{border:2px solid #000;border-radius:20px;padding:14px 16px;}legend{padding:0 6px;font-weight:800;font-size:13px;}label{display:flex;flex-direction:column;font-size:12px;font-weight:700;gap:4px;margin-bottom:10px;}input,select,textarea{border:2px solid #000;border-radius:12px;padding:8px 10px;font-size:13px;font-weight:600;}table{width:100%;border-collapse:separate;border-spacing:0;min-width:620px;}th,td{border:2px solid #000;padding:6px 8px;font-size:12px;text-align:center;background:#fff;}th{background:#f0f3f6;font-weight:800;}tbody tr:nth-child(even) td{background:#fafafa;}tbody tr:hover td{background:#e7f2fa;}#status{font-size:12px;font-weight:600;min-height:22px;} .ok{color:#0a7d32;} .err{color:#b20000;}::-webkit-scrollbar{width:10px;height:10px;}::-webkit-scrollbar-track{background:#e2e8ef;border-radius:8px;}::-webkit-scrollbar-thumb{background:#97b4c7;border:2px solid #e2e8ef;border-radius:8px;}::-webkit-scrollbar-thumb:hover{background:#6f95ac;}</style></head><body><header><button class="btn" id="backBtn">⟵ رجوع</button><h1>تسوية كمية</h1><div style="flex:1"></div><button class="btn" id="reloadBtn">تحديث</button></header><main><div style="display:flex;flex-direction:column;gap:16px;"> <fieldset><legend>بحث</legend><label>بحث عن منتج<input type="text" id="searchBox" placeholder="بالاسم أو الباركود"/></label></fieldset><fieldset><legend>التسوية</legend><div id="selProd" style="font-size:12px;font-weight:600;line-height:1.5;min-height:40px;">—</div><label>الكمية الجديدة<input type="number" id="newQty" /></label><label>ملاحظة<textarea id="adjNote" rows="2"></textarea></label><button class="btn" id="doAdjust" disabled>تنفيذ التسوية</button><div id="status"></div></fieldset></div><div style="overflow:auto;"><table><thead><tr><th>ID</th><th>الاسم</th><th>الباركود</th><th>المخزن</th><th>الكمية</th><th>سماح بالسالب</th></tr></thead><tbody id="prodBody"></tbody></table></div></main><script src="navigation.js"></script><script>(function(){const backBtn=document.getElementById('backBtn');backBtn&&backBtn.addEventListener('click',()=>window.location.href='index.html');const search=document.getElementById('searchBox');const body=document.getElementById('prodBody');const selBox=document.getElementById('selProd');const newQty=document.getElementById('newQty');const note=document.getElementById('adjNote');const doBtn=document.getElementById('doAdjust');const status=document.getElementById('status');let rows=[];let selected=null;async function load(){const r=await window.api.productsList(search.value.trim());if(r.ok){rows=r.rows;render();}}function render(){body.innerHTML=rows.map(p=>`<tr data-id="${p.id}" style="cursor:pointer;"><td>${p.id}</td><td>${p.name||''}</td><td>${p.barcode||''}</td><td>${p.store_id||''}</td><td>${p.qty||0}</td><td>${p.allow_negative? 'نعم':'لا'}</td></tr>`).join('')||'<tr><td colspan="6">لا يوجد</td></tr>';}body.addEventListener('click',e=>{const tr=e.target.closest('tr[data-id]');if(!tr)return;selected=rows.find(r=>r.id==tr.dataset.id);if(!selected)return;selBox.innerHTML=`<div><b>${selected.name}</b></div><div>الكمية الحالية: ${selected.qty||0}</div>`;newQty.value=selected.qty||0;doBtn.disabled=false;});search.addEventListener('input',()=>{load();});document.getElementById('reloadBtn').addEventListener('click',load);doBtn.addEventListener('click',async()=>{if(!selected)return;status.textContent='...';const user=JSON.parse(sessionStorage.getItem('asas_user')||'{}');try{const payload={product_id:selected.id,new_qty:parseFloat(newQty.value),note:note.value||'',user_id:user.id};const r=await window.api.inventoryAdjust(payload);if(r.ok){status.innerHTML='<span class="ok">تمت التسوية</span>';load();}else status.innerHTML='<span class="err">'+(r.msg||'فشل')+'</span>';}catch(err){status.innerHTML='<span class="err">خطأ</span>';}});load();})();</script></body></html>
