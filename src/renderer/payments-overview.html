<!DOCTYPE html><html lang='ar' dir='rtl'><head><meta charset='UTF-8'><title>ملخص المدفوعات</title><style>*{box-sizing:border-box;font-family:Tahoma,Arial,sans-serif;}body{margin:0;background:#f4f8fb;color:#0d2d3a;}header{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:2px solid #000;background:#fff;}h1{margin:0;font-size:20px;font-weight:800;}button.btn{cursor:pointer;font-size:13px;font-weight:700;padding:9px 18px;border:2px solid #000;background:#fff;border-radius:14px;transition:.25s;}button.btn:hover{background:#eaf4ff;transform:translateY(-2px);}main{padding:18px;display:grid;gap:18px;}#cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;} .card{background:#fff;border:2px solid #000;border-radius:20px;padding:14px 16px;display:flex;flex-direction:column;gap:4px;box-shadow:0 4px 10px -4px rgba(0,0,0,0.15);} .card h3{margin:0;font-size:13px;font-weight:800;} .card .val{font-size:18px;font-weight:800;direction:ltr;}table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px;}th,td{border:2px solid #000;padding:6px 8px;font-size:12px;text-align:center;background:#fff;}th{background:#f0f3f6;font-weight:800;}tbody tr:nth-child(even) td{background:#fafafa;}tbody tr:hover td{background:#e7f2fa;}form#fForm{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;background:#fff;padding:14px 16px;border:2px solid #000;border-radius:20px;}label.small{display:flex;flex-direction:column;font-size:11px;font-weight:700;gap:4px;}select,input,textarea{border:2px solid #000;border-radius:12px;padding:6px 10px;font-size:12px;font-weight:600;}fieldset{border:2px solid #000;border-radius:18px;padding:14px 16px;background:#fff;display:none;}legend{padding:0 6px;font-weight:700;font-size:12px;}#receiptStatus{font-size:11px;font-weight:700;margin-top:6px;} .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:800;background:#0d567c;color:#fff;} .b-exp{background:#b30000;} .b-rec{background:#067a06;}::-webkit-scrollbar{width:10px;height:10px;}::-webkit-scrollbar-track{background:#e2e8ef;border-radius:8px;}::-webkit-scrollbar-thumb{background:#97b4c7;border:2px solid #e2e8ef;border-radius:8px;}::-webkit-scrollbar-thumb:hover{background:#6f95ac;}button.act{cursor:pointer;border:1px solid #000;background:#fff;font-size:11px;padding:2px 6px;margin:0 2px;border-radius:6px;}button.act:hover{background:#dff2ff;}tr.editing td{background:#fff3c4 !important;}</style></head><body><header><button id='backBtn' class='btn'>⟵ رجوع</button><h1>ملخص المدفوعات</h1><div style='flex:1'></div><button id='btnToggleReceipt' class='btn'>سند قبض</button><button id='reloadBtn' class='btn'>تحديث</button></header><main><form id='fForm'><label class='small'>الفترة<select id='period'><option value='today'>اليوم</option><option value='week'>الأسبوع</option><option value='month' selected>الشهر</option><option value='year'>السنة</option><option value='all'>الكل</option></select></label><label class='small'>من<input type='date' id='fFrom'></label><label class='small'>إلى<input type='date' id='fTo'></label><button class='btn' type='submit'>تطبيق</button><div style='margin-inline-start:auto;font-size:12px;font-weight:700;'>مصروفات: <span id='totalExp'>0</span> | قبض: <span id='totalRec'>0</span> | صافي: <span id='netFlow'>0</span></div></form><fieldset id='receiptBox'><legend>سند قبض</legend><div style='display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;'><label class='small'>المبلغ<input type='number' id='rAmount'></label><label class='small'>الطريقة<select id='rMethod'><option value='cash'>نقدي</option><option value='card'>بطاقة</option><option value='bank'>تحويل</option></select></label><label class='small'>المصدر/صندوق<input id='rSource'></label><label class='small'>اسم العميل<input id='rCustName'></label><label class='small'>جوال<input id='rPhone'></label><label class='small' style='grid-column:1/-1;'>ملاحظة<textarea id='rNote' rows='2'></textarea></label></div><button id='saveReceipt' class='btn' style='margin-top:6px;'>حفظ</button><div id='receiptStatus'></div></fieldset><div id='cards'></div><div style='overflow:auto;'><table><thead><tr><th>#</th><th>نوع</th><th>المبلغ</th><th>طريقة</th><th>تفاصيل</th><th>ملاحظة</th><th>تاريخ</th><th>إجراءات</th></tr></thead><tbody id='tbody'></tbody></table></div></main><script src='navigation.js'></script><script>(function(){const tbody=document.getElementById('tbody');const receiptBox=document.getElementById('receiptBox');let mergedCache=[];let editingId=null;function toggleBox(force){if(force===true){receiptBox.style.display='block';return;} if(force===false){receiptBox.style.display='none';return;} receiptBox.style.display=receiptBox.style.display==='block'?'none':'block';}document.getElementById('btnToggleReceipt').onclick=()=>{toggleBox(); if(receiptBox.style.display==='block'){document.getElementById('rAmount').focus();}};if(location.hash==='#add-receipt'){toggleBox(true); setTimeout(()=>document.getElementById('rAmount').focus(),60);}async function load(){const f={};const from=document.getElementById('fFrom').value;const to=document.getElementById('fTo').value;if(from) f.from=from;if(to){const dt=new Date(to);dt.setDate(dt.getDate()+1);f.to=dt.toISOString();}const exp=await window.api.reportExpenses(f);let expensesTotal=0, expensesRows=[];if(exp.ok){expensesTotal=exp.data.total;expensesRows=exp.data.rows.map(r=>({...r,_type:'expense'}));}const rec=await window.api.receiptsList(f);let receiptsTotal=0, receiptsRows=[];if(rec.ok){receiptsTotal=rec.data.total;receiptsRows=rec.data.rows.map(r=>({...r,_type:'receipt'}));}mergedCache=expensesRows.concat(receiptsRows).sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));renderRows();document.getElementById('totalExp').textContent=expensesTotal.toFixed(2);document.getElementById('totalRec').textContent=receiptsTotal.toFixed(2);document.getElementById('netFlow').textContent=(receiptsTotal-expensesTotal).toFixed(2);const cards=document.getElementById('cards');cards.innerHTML=`<div class='card'><h3>مصروفات</h3><div class='val'>${expensesTotal.toFixed(2)}</div></div><div class='card'><h3>قبوضات</h3><div class='val'>${receiptsTotal.toFixed(2)}</div></div><div class='card'><h3>صافي التدفق</h3><div class='val'>${(receiptsTotal-expensesTotal).toFixed(2)}</div></div>`;}function renderRows(){tbody.innerHTML=mergedCache.map((r,i)=>`<tr data-id='${r.id||''}' data-type='${r._type}'><td>${i+1}</td><td>${r._type==='expense'?'<span class=\"badge b-exp\">صرف</span>':'<span class=\"badge b-rec\">قبض</span>'}</td><td>${(r.amount||0).toFixed(2)}</td><td>${r.method||'-'}</td><td>${r._type==='expense'?(r.category||''):(r.customer_name||r.source||'')}</td><td>${(r.note||'').slice(0,50)}</td><td>${(r.created_at||'').replace('T',' ').slice(0,16)}</td><td>${r._type==='receipt'?actionBtns(r):''}</td></tr>`).join('') || '<tr><td colspan=8>لا يوجد</td></tr>';}function actionBtns(r){return `<button class='act act-edit' title='تعديل'>✎</button><button class='act act-del' title='حذف'>🗑</button><button class='act act-pdf' title='PDF'>📄</button><button class='act act-print' title='طباعة'>🖨</button>`;}function fillForm(r){editingId=r.id;toggleBox(true);document.getElementById('rAmount').value=r.amount||'';document.getElementById('rMethod').value=r.method||'cash';document.getElementById('rSource').value=r.source||'';document.getElementById('rCustName').value=r.customer_name||'';document.getElementById('rPhone').value=r.phone||'';document.getElementById('rNote').value=r.note||'';document.getElementById('saveReceipt').textContent='تحديث';document.getElementById('receiptStatus').textContent='وضع تعديل للسند رقم '+r.id;[...tbody.querySelectorAll('tr')].forEach(tr=>tr.classList.remove('editing'));const tr=tbody.querySelector(`tr[data-id='${r.id}']`);if(tr) tr.classList.add('editing');}
// حفظ/تحديث سند قبض مع رسائل أدق
async function saveReceipt(){const amount=parseFloat(document.getElementById('rAmount').value)||0;if(!amount){alert('أدخل المبلغ');return;}if(!window.api||!window.api.receiptAdd){alert('API غير جاهز – أعد تشغيل التطبيق');return;}const payload={amount,method:document.getElementById('rMethod').value,source:document.getElementById('rSource').value,customer_name:document.getElementById('rCustName').value,phone:document.getElementById('rPhone').value,note:document.getElementById('rNote').value};const st=document.getElementById('receiptStatus');st.textContent='جارٍ الحفظ...';let r;try{r= editingId ? await window.api.receiptUpdate(editingId,payload) : await window.api.receiptAdd(payload);}catch(err){console.error('IPC receipt error',err);st.textContent='فشل الاتصال بـ IPC: '+(err&&err.message?err.message:'');return;}if(r&&r.ok){st.textContent=editingId?'تم التحديث بنجاح':'تم الحفظ بنجاح';if(!editingId){document.getElementById('rAmount').value='';document.getElementById('rNote').value='';}editingId=null;document.getElementById('saveReceipt').textContent='حفظ';load();}else{const msg=(r&&r.msg)||'فشل غير معروف';if(/لا تملك صلاحية/.test(msg)){st.textContent=msg+' – اطلب تفعيل صلاحية المالية (1024)';}else{st.textContent='خطأ: '+msg;}}}
function clearEdit(){editingId=null;document.getElementById('saveReceipt').textContent='حفظ';document.getElementById('receiptStatus').textContent='';[...tbody.querySelectorAll('tr')].forEach(tr=>tr.classList.remove('editing'));document.getElementById('rAmount').value='';document.getElementById('rMethod').value='cash';document.getElementById('rSource').value='';document.getElementById('rCustName').value='';document.getElementById('rPhone').value='';document.getElementById('rNote').value='';}tbody.addEventListener('click',async e=>{const btn=e.target.closest('button.act');if(!btn) return;const tr=btn.closest('tr');const id=parseInt(tr.getAttribute('data-id'));const type=tr.getAttribute('data-type');if(type!=='receipt') return;const row=mergedCache.find(r=>r.id===id && r._type==='receipt');if(btn.classList.contains('act-edit')){fillForm(row);}else if(btn.classList.contains('act-del')){if(confirm('حذف السند؟')){const res=await window.api.receiptDelete(id);if(res.ok){load();if(editingId===id) clearEdit();}else alert(res.msg||'فشل الحذف');}}else if(btn.classList.contains('act-pdf')){const res=await window.api.receiptPdf(id);if(res.ok){alert('تم إنشاء PDF:\n'+res.file);}else alert(res.msg||'فشل PDF');}else if(btn.classList.contains('act-print')){const res=await window.api.receiptPrintHtml(id);if(!res.ok) alert(res.msg||'فشل الطباعة');}});document.getElementById('fForm').addEventListener('submit',e=>{e.preventDefault();load();});document.getElementById('reloadBtn').addEventListener('click',load);document.getElementById('backBtn').addEventListener('click',()=>window.location.href='index.html');document.getElementById('saveReceipt').addEventListener('click',saveReceipt);document.addEventListener('keydown',e=>{if(e.key==='Escape' && editingId){clearEdit();}});// اختبار صلاحية المالية مبكراً
(async()=>{try{const t=await window.api.receiptsList({from:new Date(Date.now()-300000).toISOString()});if(!t.ok){document.getElementById('receiptStatus').textContent='تنبيه: لا تملك صلاحية المالية (1024) – لن يتم الحفظ';}}catch(_){}})();load();})();</script></body></html>
