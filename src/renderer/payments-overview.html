<!DOCTYPE html><html lang='ar' dir='rtl'><head><meta charset='UTF-8'><title>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</title><style>*{box-sizing:border-box;font-family:Tahoma,Arial,sans-serif;}body{margin:0;background:#f4f8fb;color:#0d2d3a;}header{display:flex;align-items:center;gap:12px;padding:12px 18px;border-bottom:2px solid #000;background:#fff;}h1{margin:0;font-size:20px;font-weight:800;}button.btn{cursor:pointer;font-size:13px;font-weight:700;padding:9px 18px;border:2px solid #000;background:#fff;border-radius:14px;transition:.25s;}button.btn:hover{background:#eaf4ff;transform:translateY(-2px);}main{padding:18px;display:grid;gap:18px;}#cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px;} .card{background:#fff;border:2px solid #000;border-radius:20px;padding:14px 16px;display:flex;flex-direction:column;gap:4px;box-shadow:0 4px 10px -4px rgba(0,0,0,0.15);} .card h3{margin:0;font-size:13px;font-weight:800;} .card .val{font-size:18px;font-weight:800;direction:ltr;}table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px;}th,td{border:2px solid #000;padding:6px 8px;font-size:12px;text-align:center;background:#fff;}th{background:#f0f3f6;font-weight:800;}tbody tr:nth-child(even) td{background:#fafafa;}tbody tr:hover td{background:#e7f2fa;}form#fForm{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end;background:#fff;padding:14px 16px;border:2px solid #000;border-radius:20px;}label.small{display:flex;flex-direction:column;font-size:11px;font-weight:700;gap:4px;}select,input,textarea{border:2px solid #000;border-radius:12px;padding:6px 10px;font-size:12px;font-weight:600;}fieldset{border:2px solid #000;border-radius:18px;padding:14px 16px;background:#fff;display:none;}legend{padding:0 6px;font-weight:700;font-size:12px;}#receiptStatus{font-size:11px;font-weight:700;margin-top:6px;} .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:10px;font-weight:800;background:#0d567c;color:#fff;} .b-exp{background:#b30000;} .b-rec{background:#067a06;}::-webkit-scrollbar{width:10px;height:10px;}::-webkit-scrollbar-track{background:#e2e8ef;border-radius:8px;}::-webkit-scrollbar-thumb{background:#97b4c7;border:2px solid #e2e8ef;border-radius:8px;}::-webkit-scrollbar-thumb:hover{background:#6f95ac;}button.act{cursor:pointer;border:1px solid #000;background:#fff;font-size:11px;padding:2px 6px;margin:0 2px;border-radius:6px;}button.act:hover{background:#dff2ff;}tr.editing td{background:#fff3c4 !important;}</style></head><body><header><button id='backBtn' class='btn'>âŸµ Ø±Ø¬ÙˆØ¹</button><h1>Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h1><div style='flex:1'></div><button id='btnToggleReceipt' class='btn'>Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</button><button id='reloadBtn' class='btn'>ØªØ­Ø¯ÙŠØ«</button></header><main><form id='fForm'><label class='small'>Ø§Ù„ÙØªØ±Ø©<select id='period'><option value='today'>Ø§Ù„ÙŠÙˆÙ…</option><option value='week'>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option><option value='month' selected>Ø§Ù„Ø´Ù‡Ø±</option><option value='year'>Ø§Ù„Ø³Ù†Ø©</option><option value='all'>Ø§Ù„ÙƒÙ„</option></select></label><label class='small'>Ù…Ù†<input type='date' id='fFrom'></label><label class='small'>Ø¥Ù„Ù‰<input type='date' id='fTo'></label><button class='btn' type='submit'>ØªØ·Ø¨ÙŠÙ‚</button><div style='margin-inline-start:auto;font-size:12px;font-weight:700;'>Ù…ØµØ±ÙˆÙØ§Øª: <span id='totalExp'>0</span> | Ù‚Ø¨Ø¶: <span id='totalRec'>0</span> | ØµØ§ÙÙŠ: <span id='netFlow'>0</span></div></form><fieldset id='receiptBox'><legend>Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</legend><div style='display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;'><label class='small'>Ø§Ù„Ù…Ø¨Ù„Øº<input type='number' id='rAmount'></label><label class='small'>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©<select id='rMethod'><option value='cash'>Ù†Ù‚Ø¯ÙŠ</option><option value='card'>Ø¨Ø·Ø§Ù‚Ø©</option><option value='bank'>ØªØ­ÙˆÙŠÙ„</option></select></label><label class='small'>Ø§Ù„Ù…ØµØ¯Ø±/ØµÙ†Ø¯ÙˆÙ‚<input id='rSource'></label><label class='small'>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„<input id='rCustName'></label><label class='small'>Ø¬ÙˆØ§Ù„<input id='rPhone'></label><label class='small' style='grid-column:1/-1;'>Ù…Ù„Ø§Ø­Ø¸Ø©<textarea id='rNote' rows='2'></textarea></label></div><button id='saveReceipt' class='btn' style='margin-top:6px;'>Ø­ÙØ¸</button><div id='receiptStatus'></div></fieldset><div id='cards'></div><div style='overflow:auto;'><table><thead><tr><th>#</th><th>Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø·Ø±ÙŠÙ‚Ø©</th><th>ØªÙØ§ØµÙŠÙ„</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id='tbody'></tbody></table></div></main><script src='navigation.js'></script><script>(function(){const tbody=document.getElementById('tbody');const receiptBox=document.getElementById('receiptBox');let mergedCache=[];let editingId=null;function toggleBox(force){if(force===true){receiptBox.style.display='block';return;} if(force===false){receiptBox.style.display='none';return;} receiptBox.style.display=receiptBox.style.display==='block'?'none':'block';}document.getElementById('btnToggleReceipt').onclick=()=>{toggleBox(); if(receiptBox.style.display==='block'){document.getElementById('rAmount').focus();}};if(location.hash==='#add-receipt'){toggleBox(true); setTimeout(()=>document.getElementById('rAmount').focus(),60);}async function load(){const f={};const from=document.getElementById('fFrom').value;const to=document.getElementById('fTo').value;if(from) f.from=from;if(to){const dt=new Date(to);dt.setDate(dt.getDate()+1);f.to=dt.toISOString();}const exp=await window.api.reportExpenses(f);let expensesTotal=0, expensesRows=[];if(exp.ok){expensesTotal=exp.data.total;expensesRows=exp.data.rows.map(r=>({...r,_type:'expense'}));}const rec=await window.api.receiptsList(f);let receiptsTotal=0, receiptsRows=[];if(rec.ok){receiptsTotal=rec.data.total;receiptsRows=rec.data.rows.map(r=>({...r,_type:'receipt'}));}mergedCache=expensesRows.concat(receiptsRows).sort((a,b)=>(b.created_at||'').localeCompare(a.created_at||''));renderRows();document.getElementById('totalExp').textContent=expensesTotal.toFixed(2);document.getElementById('totalRec').textContent=receiptsTotal.toFixed(2);document.getElementById('netFlow').textContent=(receiptsTotal-expensesTotal).toFixed(2);const cards=document.getElementById('cards');cards.innerHTML=`<div class='card'><h3>Ù…ØµØ±ÙˆÙØ§Øª</h3><div class='val'>${expensesTotal.toFixed(2)}</div></div><div class='card'><h3>Ù‚Ø¨ÙˆØ¶Ø§Øª</h3><div class='val'>${receiptsTotal.toFixed(2)}</div></div><div class='card'><h3>ØµØ§ÙÙŠ Ø§Ù„ØªØ¯ÙÙ‚</h3><div class='val'>${(receiptsTotal-expensesTotal).toFixed(2)}</div></div>`;}function renderRows(){tbody.innerHTML=mergedCache.map((r,i)=>`<tr data-id='${r.id||''}' data-type='${r._type}'><td>${i+1}</td><td>${r._type==='expense'?'<span class=\"badge b-exp\">ØµØ±Ù</span>':'<span class=\"badge b-rec\">Ù‚Ø¨Ø¶</span>'}</td><td>${(r.amount||0).toFixed(2)}</td><td>${r.method||'-'}</td><td>${r._type==='expense'?(r.category||''):(r.customer_name||r.source||'')}</td><td>${(r.note||'').slice(0,50)}</td><td>${(r.created_at||'').replace('T',' ').slice(0,16)}</td><td>${r._type==='receipt'?actionBtns(r):''}</td></tr>`).join('') || '<tr><td colspan=8>Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>';}function actionBtns(r){return `<button class='act act-edit' title='ØªØ¹Ø¯ÙŠÙ„'>âœ</button><button class='act act-del' title='Ø­Ø°Ù'>ğŸ—‘</button><button class='act act-pdf' title='PDF'>ğŸ“„</button><button class='act act-print' title='Ø·Ø¨Ø§Ø¹Ø©'>ğŸ–¨</button>`;}function fillForm(r){editingId=r.id;toggleBox(true);document.getElementById('rAmount').value=r.amount||'';document.getElementById('rMethod').value=r.method||'cash';document.getElementById('rSource').value=r.source||'';document.getElementById('rCustName').value=r.customer_name||'';document.getElementById('rPhone').value=r.phone||'';document.getElementById('rNote').value=r.note||'';document.getElementById('saveReceipt').textContent='ØªØ­Ø¯ÙŠØ«';document.getElementById('receiptStatus').textContent='ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù„Ø³Ù†Ø¯ Ø±Ù‚Ù… '+r.id;[...tbody.querySelectorAll('tr')].forEach(tr=>tr.classList.remove('editing'));const tr=tbody.querySelector(`tr[data-id='${r.id}']`);if(tr) tr.classList.add('editing');}
// Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ« Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ Ù…Ø¹ Ø±Ø³Ø§Ø¦Ù„ Ø£Ø¯Ù‚
async function saveReceipt(){const amount=parseFloat(document.getElementById('rAmount').value)||0;if(!amount){alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº');return;}if(!window.api||!window.api.receiptAdd){alert('API ØºÙŠØ± Ø¬Ø§Ù‡Ø² â€“ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');return;}const payload={amount,method:document.getElementById('rMethod').value,source:document.getElementById('rSource').value,customer_name:document.getElementById('rCustName').value,phone:document.getElementById('rPhone').value,note:document.getElementById('rNote').value};const st=document.getElementById('receiptStatus');st.textContent='Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';let r;try{r= editingId ? await window.api.receiptUpdate(editingId,payload) : await window.api.receiptAdd(payload);}catch(err){console.error('IPC receipt error',err);st.textContent='ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ IPC: '+(err&&err.message?err.message:'');return;}if(r&&r.ok){st.textContent=editingId?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­':'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­';if(!editingId){document.getElementById('rAmount').value='';document.getElementById('rNote').value='';}editingId=null;document.getElementById('saveReceipt').textContent='Ø­ÙØ¸';load();}else{const msg=(r&&r.msg)||'ÙØ´Ù„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';if(/Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©/.test(msg)){st.textContent=msg+' â€“ Ø§Ø·Ù„Ø¨ ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (1024)';}else{st.textContent='Ø®Ø·Ø£: '+msg;}}}
function clearEdit(){editingId=null;document.getElementById('saveReceipt').textContent='Ø­ÙØ¸';document.getElementById('receiptStatus').textContent='';[...tbody.querySelectorAll('tr')].forEach(tr=>tr.classList.remove('editing'));document.getElementById('rAmount').value='';document.getElementById('rMethod').value='cash';document.getElementById('rSource').value='';document.getElementById('rCustName').value='';document.getElementById('rPhone').value='';document.getElementById('rNote').value='';}tbody.addEventListener('click',async e=>{const btn=e.target.closest('button.act');if(!btn) return;const tr=btn.closest('tr');const id=parseInt(tr.getAttribute('data-id'));const type=tr.getAttribute('data-type');if(type!=='receipt') return;const row=mergedCache.find(r=>r.id===id && r._type==='receipt');if(btn.classList.contains('act-edit')){fillForm(row);}else if(btn.classList.contains('act-del')){if(confirm('Ø­Ø°Ù Ø§Ù„Ø³Ù†Ø¯ØŸ')){const res=await window.api.receiptDelete(id);if(res.ok){load();if(editingId===id) clearEdit();}else alert(res.msg||'ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');}}else if(btn.classList.contains('act-pdf')){const res=await window.api.receiptPdf(id);if(res.ok){alert('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ PDF:\n'+res.file);}else alert(res.msg||'ÙØ´Ù„ PDF');}else if(btn.classList.contains('act-print')){const res=await window.api.receiptPrintHtml(id);if(!res.ok) alert(res.msg||'ÙØ´Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©');}});document.getElementById('fForm').addEventListener('submit',e=>{e.preventDefault();load();});document.getElementById('reloadBtn').addEventListener('click',load);document.getElementById('backBtn').addEventListener('click',()=>window.location.href='index.html');document.getElementById('saveReceipt').addEventListener('click',saveReceipt);document.addEventListener('keydown',e=>{if(e.key==='Escape' && editingId){clearEdit();}});// Ø§Ø®ØªØ¨Ø§Ø± ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù…Ø¨ÙƒØ±Ø§Ù‹
(async()=>{try{const t=await window.api.receiptsList({from:new Date(Date.now()-300000).toISOString()});if(!t.ok){document.getElementById('receiptStatus').textContent='ØªÙ†Ø¨ÙŠÙ‡: Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (1024) â€“ Ù„Ù† ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸';}}catch(_){}})();load();})();</script></body></html>
